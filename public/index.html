<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ê±°ë¦¬ ë¹„êµ ì›¹ì•±</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
      body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; background: #f8fafc; }
      h1 { font-size: 20px; margin-bottom: 16px; }
      .toolbar { display: flex; gap: 8px; margin-bottom: 12px; align-items: center; }
      input[type="text"] { padding: 8px 10px; border: 1px solid #cbd5e1; border-radius: 6px; width: 360px; background: #fff; }
      button { padding: 8px 12px; background: #2563eb; color: white; border: none; border-radius: 6px; cursor: pointer; }
      button:disabled { background: #93c5fd; cursor: not-allowed; }
      table { width: 100%; border-collapse: collapse; background: white; table-layout: fixed; }
      th, td { border: 1px solid #e2e8f0; padding: 8px; font-size: 14px; vertical-align: top; }
      th { background: #f1f5f9; text-align: left; }
      textarea { width: 100%; height: 260px; border: none; outline: none; padding: 6px; resize: vertical; font-size: 14px; }
      .note { color: #64748b; font-size: 12px; margin-bottom: 8px; }
      .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; }
      .subnote { color:#475569; font-size:12px; }
    </style>
  </head>
  <body>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>ğŸ“</text></svg>">
    <h1>ì¹´ì¹´ì˜¤ë§µ / Të§µ ìµœë‹¨ê±°ë¦¬ ë¹„êµ</h1>
    <div class="note">ì²« ë²ˆì§¸ ì—´ì— ì£¼ì†Œ(ì¶œë°œì§€)ë¥¼ í–‰ ë‹¨ìœ„ë¡œ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”. ìƒë‹¨ ì…ë ¥ì°½ì— ë¹„êµ ëŒ€ìƒ ì£¼ì†Œ(ë„ì°©ì§€)ë¥¼ ë„£ê³  ê±°ë¦¬ ë¹„êµë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.</div>
    <div class="toolbar">
      <input id="destination" type="text" placeholder="ë„ì°©ì§€ ì£¼ì†Œ ë˜ëŠ” ì¥ì†Œëª… (ì˜ˆ: ì„œìš¸ì—­, ì„¸ì¢…ëŒ€ë¡œ 110)" />
      <button id="compareBtn">ë¹„êµí•˜ê¸°</button>
      <button id="downloadBtn">ì—‘ì…€(CSV) ë‹¤ìš´ë¡œë“œ</button>
      <span id="status" class="note"></span>
    </div>

    <div class="note">ê±°ì£¼ì§€ ì£¼ì†Œë¥¼ ì•„ë˜ ì…ë ¥ì¹¸ì— ì—¬ëŸ¬ ì¤„ë¡œ ë¶™ì—¬ë„£ê³ , ë¹„êµë¥¼ ì‹¤í–‰í•˜ì„¸ìš”.</div>
    <textarea id="addressBulk" placeholder="í•œ ì¤„ì— í•˜ë‚˜ì”© ì£¼ì†Œë¥¼ ë¶™ì—¬ë„£ê¸°"></textarea>

    <table>
      <thead>
        <tr>
          <th style="width: 52%">ì „ì²˜ë¦¬ ì£¼ì†Œ</th>
          <th style="width: 16%">ì¹´ì¹´ì˜¤ë§µ (km)</th>
          <th style="width: 16%">Të§µ (km)</th>
          <th style="width: 16%">GAP (km)</th>
        </tr>
      </thead>
      <tbody id="resultsBody"></tbody>
    </table>

    <script>
      const destinationInput = document.getElementById('destination');
      const compareBtn = document.getElementById('compareBtn');
      const statusEl = document.getElementById('status');
      const addressBulk = document.getElementById('addressBulk');
      const resultsBody = document.getElementById('resultsBody');
      const downloadBtn = document.getElementById('downloadBtn');
      let lastExportRows = [];

      function toKmText(meters) {
        if (meters == null || meters === '') return '';
        const km = Number(meters) / 1000;
        if (Number.isNaN(km)) return '';
        return km.toFixed(2);
      }

      function toKmNumber(meters) {
        if (meters == null || meters === '') return null;
        const km = Number(meters) / 1000;
        if (Number.isNaN(km)) return null;
        return km;
      }

      function renderResults(addresses, results) {
        resultsBody.innerHTML = '';
        lastExportRows = [];
        const n = Math.max(addresses.length, results.length);
        for (let i = 0; i < n; i++) {
          const r = results[i] || {};
          const tr = document.createElement('tr');
          const tdNorm = document.createElement('td');
          tdNorm.textContent = r.normalizedOrigin || '';
          const tdK = document.createElement('td');
          const kakaoKm = toKmNumber(r.kakao);
          tdK.textContent = kakaoKm != null ? kakaoKm.toFixed(2) : '';
          const tdT = document.createElement('td');
          const tmapKm = toKmNumber(r.tmap);
          tdT.textContent = tmapKm != null ? tmapKm.toFixed(2) : '';
          const tdGap = document.createElement('td');
          const gap = kakaoKm != null && tmapKm != null ? Math.abs(kakaoKm - tmapKm) : null;
          tdGap.textContent = gap != null ? gap.toFixed(2) : '';
          tr.appendChild(tdNorm);
          tr.appendChild(tdK);
          tr.appendChild(tdT);
          tr.appendChild(tdGap);
          resultsBody.appendChild(tr);

          lastExportRows.push([
            tdNorm.textContent,
            tdK.textContent,
            tdT.textContent,
            tdGap.textContent
          ]);
        }
      }

      compareBtn.addEventListener('click', async () => {
        const destinationAddress = destinationInput.value.trim();
        const addresses = addressBulk.value
          .split(/\r?\n/)
          .map(s => s.trim())
          .filter(Boolean);

        if (!destinationAddress) {
          alert('ë„ì°©ì§€ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
          return;
        }
        if (addresses.length === 0) {
          alert('ê±°ì£¼ì§€ ì£¼ì†Œë¥¼ í•œ ì¤„ì— í•˜ë‚˜ì”© ì…ë ¥í•˜ì„¸ìš”.');
          return;
        }
        compareBtn.disabled = true;
        statusEl.textContent = 'ê³„ì‚° ì¤‘... (ì£¼ì†Œ ìˆ˜: ' + addresses.length + ')';
        try {
          const body = {
            destinationAddress,
            rows: addresses.map(a => ({ address: a }))
          };
          const res = await fetch('/api/compare', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
          });
          if (!res.ok) {
            let msg = 'ì„œë²„ ì˜¤ë¥˜';
            try { const err = await res.json(); if (err?.message) msg = err.message; } catch (_) {}
            throw new Error(msg);
          }
          const data = await res.json().catch(() => ({ results: [] }));
          renderResults(addresses, data.results || []);
          statusEl.textContent += '';
          statusEl.textContent = 'ì™„ë£Œ';
        } catch (e) {
          statusEl.textContent = 'ì‹¤íŒ¨: ' + e.message;
        } finally {
          compareBtn.disabled = false;
        }
      });

      function toCsvValue(val) {
        const s = String(val ?? '');
        return '"' + s.replace(/"/g, '""') + '"';
      }

      downloadBtn.addEventListener('click', () => {
        if (!lastExportRows.length) {
          alert('ë¨¼ì € ê±°ë¦¬ ë¹„êµë¥¼ ì‹¤í–‰í•˜ì„¸ìš”.');
          return;
        }
        const header = ['ì „ì²˜ë¦¬ ì£¼ì†Œ','ì¹´ì¹´ì˜¤ë§µ (km)','Të§µ (km)','GAP (km)'];
        const csv = [header.map(toCsvValue).join(','), ...lastExportRows.map(row => row.map(toCsvValue).join(','))].join('\n');
        // Excel í•œê¸€ ê¹¨ì§ ë°©ì§€: UTF-8 BOM(\uFEFF) ì¶”ê°€
        const bom = '\uFEFF';
        const blob = new Blob([bom + csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        const ts = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
        a.download = `distance_compare_${ts}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      });
    </script>
  </body>
  </html>


